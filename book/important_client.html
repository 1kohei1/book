<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Important Client - Tock Tutorial</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="introduction.html">Introduction</a></li><li class="affix"><a href="prerequisites.html">Prerequisites</a></li><li><a href="course.html"><strong aria-hidden="true">1.</strong> Tock Course</a></li><li><ol class="section"><li><a href="environment.html"><strong aria-hidden="true">1.1.</strong> Environment Setup</a></li><li><a href="modules.html"><strong aria-hidden="true">1.2.</strong> Modules</a></li><li><ol class="section"><li><a href="application.html"><strong aria-hidden="true">1.2.1.</strong> Application</a></li><li><a href="important_client.html" class="active"><strong aria-hidden="true">1.2.2.</strong> Important Client</a></li><li><a href="capsule.html"><strong aria-hidden="true">1.2.3.</strong> Capsule</a></li></ol></li><li><a href="graduation.html"><strong aria-hidden="true">1.3.</strong> Graduation</a></li></ol></li><li><a href="tutorials/tutorials.html"><strong aria-hidden="true">2.</strong> Mini Tutorials</a></li><li><ol class="section"><li><a href="tutorials/01_running_blink.html"><strong aria-hidden="true">2.1.</strong> Blink an LED</a></li><li><a href="tutorials/02_button_print.html"><strong aria-hidden="true">2.2.</strong> Button to Printf()</a></li><li><a href="tutorials/03_ble_scan.html"><strong aria-hidden="true">2.3.</strong> BLE Advertisement Scanning</a></li><li><a href="tutorials/04_sensors_and_drivers.html"><strong aria-hidden="true">2.4.</strong> Sample Sensors and Use Drivers</a></li><li><a href="tutorials/05_ipc.html"><strong aria-hidden="true">2.5.</strong> Inter-process Communication</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Tock Tutorial</h1>

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#keep-the-client-happy" id="keep-the-client-happy">Keep the client happy</a></h1>
<p>You, an engineer newly added to a top-secret project in your organization, have
been directed to commission a new imix node for your most important client. The
directions you receive are terse, but helpful:</p>
<pre><code>On Sunday, Nov 4, 2018, Director Hines wrote:

Welcome to the team, need you to get started right away. The client needs an
imix setup with their two apps -- ASAP. Make sure it is working, we need to keep
this client happy.

- DH
</code></pre>
<p>Hmm, ok, not a lot to go on, but luckily in orientation you learned how to flash
a kernel and apps on to the imix board, so you are all set for your first
assignment.</p>
<p>Poking around, you notice a folder called &quot;important-client&quot;. While that is a
good start, you also notice that it has two apps inside of it! &quot;Alright!&quot; you
are thinking, &quot;My first day is shaping up to go pretty smoothly.&quot;</p>
<p>After installing those two apps, which are a little mysterious still, you decide
that it would also be a good idea to install an app you are more familiar with:
the &quot;blink&quot; app. After doing all of that, you run <code>tockloader list</code> and see the
following:</p>
<pre><code>$ tockloader list

No device name specified. Using default &quot;tock&quot;
Using &quot;/dev/ttyUSB1 - imix IoT Module - TockOS&quot;

[App 0]
  Name:                  app2
  Enabled:               True
  Sticky:                False
  Total Size in Flash:   16384 bytes


[App 1]
  Name:                  app1
  Enabled:               True
  Sticky:                False
  Total Size in Flash:   8192 bytes


[App 2]
  Name:                  blink
  Enabled:               True
  Sticky:                False
  Total Size in Flash:   2048 bytes


Finished in 1.959 seconds
</code></pre>
<hr />
<blockquote>
<p><strong>Checkpoint</strong></p>
<p>Make sure you have these apps installed correctly and <code>tockloader list</code>
produces similar output as shown here.</p>
</blockquote>
<hr />
<p>Great! Now you check that the LED is blinking, and sure enough, no problems
there. The blink app was just for testing, so you <code>tockloader uninstall blink</code>
to remove that. So far, so good, Tock! But, before you prepare to head home
after a successful day, you start to wonder if maybe this was a little too easy.
Also, if you get this wrong, it's not going to look good as the new person on
the team.</p>
<p>Looking in the folders for the two applications, you notice a brief description
of the apps, and a URL. Ok, maybe you can check if everything is working.
After trying things for a little bit, everything seems to be in order. You
tell the director the board is ready and head home a little early—you did
just successfully complete your first project for a major client after all.</p>
<h2><a class="header" href="#back-at-work-the-next-day" id="back-at-work-the-next-day">Back at Work the Next Day</a></h2>
<p>Expecting a more challenging project after how well things went yesterday, you
are instead greeted by this email:</p>
<pre><code>On Monday, Nov 5, 2018, Director Hines wrote:

I know you are new, but what did you do?? I've been getting calls all morning
from the client, the imix board you gave them ran out battery already!! Are you
sure you set up the board correctly? Fix it, and get it back to me later today.

- DH
</code></pre>
<p>Well, that's not good. You already removed the blink app, so it can't be that.
What you need is some way to inspect the board and see if something looks like
it is going awry. You first try:</p>
<pre><code>$ tockloader listen
</code></pre>
<p>to see if any debugging information is being printed. A little, but nothing
helpful. Before trying to look around the code, you decided to try sending the
board a plea for help:</p>
<pre><code>help
</code></pre>
<p>and, surprisingly, it responded!</p>
<pre><code>Welcome to the process console.
Valid commands are: help status list stop start
</code></pre>
<p>Ok! Maybe the process console can help. Try the <code>status</code> command:</p>
<pre><code>Total processes: 2
Active processes: 2
Timeslice expirations: 4277
</code></pre>
<p>It seems this tool is actually able to inspect the current system and the active
processes! But hmmm, it seems there are a lot of &quot;timeslice expirations&quot;. From
orientation, you remember that processes are allocated only a certain quantum of
time to execute, and if they exceed that the kernel forces a context switch back
to the kernel. If that is happening a lot, then the board is likely unable to go
to sleep! That could explain why the battery is draining so fast!</p>
<p>But which process is at fault? Perhaps we should try another command.
Maybe <code>list</code>:</p>
<pre><code> PID    Name                Quanta  Syscalls  Dropped Callbacks    State
  00	app2                     0       336                  0  Yielded
  01	app1                  8556   1439951                  0  Running
</code></pre>
<p>Ok! Now we have the status of individual applications. And aha! We can clearly
see the faulty application. From our testing we know that one app detects
button presses and one app is transmitting sensor data. Let's see if we can
disable the faulty app somehow and see which data packets we are still getting.
Going back to the help command, the <code>stop</code> command seems promising:</p>
<pre><code>stop &lt;app name&gt;
</code></pre>
<h2><a class="header" href="#time-to-fix-the-app" id="time-to-fix-the-app">Time to Fix the App</a></h2>
<p>After debugging, we now know a couple things about the issue:</p>
<ul>
<li>The name of the faulty app.</li>
<li>That it is functionally correct but is for some reason consuming excess CPU
cycles.</li>
</ul>
<p>Using this information, dig into the the faulty app.</p>
<h3><a class="header" href="#a-quick-fix" id="a-quick-fix">A Quick Fix</a></h3>
<p>To get the director off your back, you should be able to introduce a simple fix
that will reduce wakeups by waiting a bit between samples.</p>
<h3><a class="header" href="#a-better-way" id="a-better-way">A Better Way</a></h3>
<p>While the quick fix will slow the number of wakeups, you know that you can do
better than polling for something like a button press! Tock supports
asynchronous operations allowing user processes to <em>subscribe</em> to interrupts.</p>
<p>Looking at the button interface (in button.h), it looks like we'll first have to
enable interrupts and then sign up to listen to them.</p>
<p>Once this energy-optimal patch is in place, it'll be time to kick off a
triumphant e-mail to the director, and then off to celebrate!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="application.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="capsule.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="application.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="capsule.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
