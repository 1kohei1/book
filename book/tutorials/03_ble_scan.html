<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>BLE Advertisement Scanning - Tock Tutorial</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="affix"><a href="../introduction.html">Introduction</a></li><li><a href="../guides.html"><strong aria-hidden="true">1.</strong> Hands-on Guides</a></li><li><ol class="section"><li><a href="../getting_started.html"><strong aria-hidden="true">1.1.</strong> Getting Started</a></li><li><a href="../course.html"><strong aria-hidden="true">1.2.</strong> Tock Course</a></li><li><ol class="section"><li><a href="../course_setup.html"><strong aria-hidden="true">1.2.1.</strong> Course Setup</a></li><li><a href="../modules.html"><strong aria-hidden="true">1.2.2.</strong> Modules</a></li><li><ol class="section"><li><a href="../application.html"><strong aria-hidden="true">1.2.2.1.</strong> Application</a></li><li><a href="../important_client.html"><strong aria-hidden="true">1.2.2.2.</strong> Important Client</a></li><li><a href="../capsule.html"><strong aria-hidden="true">1.2.2.3.</strong> Capsule</a></li></ol></li><li><a href="../graduation.html"><strong aria-hidden="true">1.2.3.</strong> Graduation</a></li></ol></li><li><a href="../tutorials/tutorials.html"><strong aria-hidden="true">1.3.</strong> Mini Tutorials</a></li><li><ol class="section"><li><a href="../tutorials/01_running_blink.html"><strong aria-hidden="true">1.3.1.</strong> Blink an LED</a></li><li><a href="../tutorials/02_button_print.html"><strong aria-hidden="true">1.3.2.</strong> Button to Printf()</a></li><li><a href="../tutorials/03_ble_scan.html" class="active"><strong aria-hidden="true">1.3.3.</strong> BLE Advertisement Scanning</a></li><li><a href="../tutorials/04_sensors_and_drivers.html"><strong aria-hidden="true">1.3.4.</strong> Sample Sensors and Use Drivers</a></li><li><a href="../tutorials/05_ipc.html"><strong aria-hidden="true">1.3.5.</strong> Inter-process Communication</a></li></ol></li></ol></li><li><a href="../development/guides.html"><strong aria-hidden="true">2.</strong> Kernel Development Guides</a></li><li><ol class="section"><li><a href="../development/peripheral.html"><strong aria-hidden="true">2.1.</strong> Chip Peripheral Driver</a></li><li><a href="../development/sensor.html"><strong aria-hidden="true">2.2.</strong> Sensor Driver</a></li><li><a href="../development/syscall.html"><strong aria-hidden="true">2.3.</strong> Syscall Interface</a></li><li><a href="../development/hil.html"><strong aria-hidden="true">2.4.</strong> HIL</a></li><li><a href="../development/virtual.html"><strong aria-hidden="true">2.5.</strong> Virtualizers</a></li><li><a href="../development/tests.html"><strong aria-hidden="true">2.6.</strong> Kernel Tests</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">Tock Tutorial</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#look-a-wild-ble-packet-appeared" id="look-a-wild-ble-packet-appeared">Look! A Wild BLE Packet Appeared!</a></h1>
<blockquote>
<p>Note! This tutorial will only work on Hail and imix boards.</p>
</blockquote>
<p>This tutorial will walk you through getting an app running that scans
for BLE advertisements. Most BLE devices typically broadcast advertisements
periodically (usually once a second) to allow smartphones and other devices
to discover them. The advertisements typically contain the BLE device's ID
and name, as well as as which services the device provides, and sometimes
raw data as well.</p>
<p>To provide BLE connectivity, several Tock boards use the Nordic nRF51822
as a BLE co-processor. In this configuration, the nRF51822 runs all of
the BLE operations and exposes a command interface over a UART bus. Luckily for
us, Nordic has defined and implemented the entire interface. Better yet, they
made it interoperable with their nRF51 SDK. What this means is any BLE app
that would run on the nRF51822 directly can be compiled to run on a different
microcontroller, and any function calls that would have interacted with
the BLE hardware are instead packaged and sent to the nRF51822 co-processor.
Nordic calls this tool &quot;BLE Serialization&quot;, and Tock has a port of the
serialization libraries that Tock applications can use.</p>
<p>So, with that introduction, lets get going.</p>
<ol>
<li>
<p><strong>Initialize the BLE co-processor</strong>. The first step a BLE serialization app
must do is initialize the BLE stack on the co-processor. This can be done
with Nordic's SDK, but to simplify things Tock supports the <a href="https://github.com/lab11/nrf5x-base/tree/master/lib">Simple
BLE</a> library. The goal
of <code>simple_ble.c</code> is to wrap the details of the nRF5 SDK and the intricacies
of BLE in an easy-to-use library so you can get going with creating BLE
devices and not learning the entire spec.</p>
<pre><code class="language-c">#include &lt;simple_ble.h&gt;

// Intervals for advertising and connections.
// These are some basic settings for BLE devices. However, since we are
// only interesting in scanning, these are not particularly relevant.
simple_ble_config_t ble_config = {
  .platform_id       = 0x00, // used as 4th octet in device BLE address
  .device_id         = DEVICE_ID_DEFAULT,
  .adv_name          = &quot;Tock&quot;,
  .adv_interval      = MSEC_TO_UNITS(500, UNIT_0_625_MS),
  .min_conn_interval = MSEC_TO_UNITS(1000, UNIT_1_25_MS),
  .max_conn_interval = MSEC_TO_UNITS(1250, UNIT_1_25_MS)
};

int main () {
    printf(&quot;[Tutorial] BLE Scanning\n&quot;);

    // Setup BLE.
    simple_ble_init(&amp;ble_config);
}
</code></pre>
</li>
<li>
<p><strong>Scan for advertisements</strong>. With <code>simple_ble</code> this is pretty
straightforward.</p>
<pre><code class="language-c">int main () {
    printf(&quot;[Tutorial] BLE Scanning\n&quot;);

    // Setup BLE.
    simple_ble_init(&amp;ble_config);

    // Scan for advertisements.
    simple_ble_scan_start();
}
</code></pre>
</li>
<li>
<p><strong>Handle the advertisement received event</strong>. Just as the main Tock
microcontroller can send commands to the nRF co-processor, the co-processor
can send events back. When these occur, a variety of callbacks are generated
in <code>simple_ble</code> and then passed to users of the library. In this case, we
only care about <code>ble_evt_adv_report()</code> which is called on each advertisement
reception.</p>
<pre><code class="language-c">// Called when each advertisement is received.
void ble_evt_adv_report (ble_evt_t* p_ble_evt) {
  ble_gap_evt_adv_report_t* adv = (ble_gap_evt_adv_report_t*) &amp;p_ble_evt-&gt;evt.gap_evt.params.adv_report;
}
</code></pre>
<p>The <code>ble_evt_adv_report()</code> function is passed a pointer to a <code>ble_evt_t</code>
struct. This is a type from the Nordic nRF51 SDK, and more information
can be found in the SDK documentation.</p>
</li>
<li>
<p><strong>Display a message for each advertisement</strong>. Once we have the advertisement
callback, we can use <code>printf()</code> like normal.</p>
<pre><code class="language-c">#include &lt;stdio.h&gt;

#include &lt;led.h&gt;

// Called when each advertisement is received.
void ble_evt_adv_report (ble_evt_t* p_ble_evt) {
  ble_gap_evt_adv_report_t* adv = (ble_gap_evt_adv_report_t*) &amp;p_ble_evt-&gt;evt.gap_evt.params.adv_report;

  // Print some details about the discovered advertisement.
  printf(&quot;Recv Advertisement: [%02x:%02x:%02x:%02x:%02x:%02x] RSSI: %d, Len: %d\n&quot;,
    adv-&gt;peer_addr.addr[5], adv-&gt;peer_addr.addr[4], adv-&gt;peer_addr.addr[3],
    adv-&gt;peer_addr.addr[2], adv-&gt;peer_addr.addr[1], adv-&gt;peer_addr.addr[0],
    adv-&gt;rssi, adv-&gt;dlen);

  // Also toggle the first LED.
  led_toggle(0);
}
</code></pre>
</li>
<li>
<p><strong>Handle some BLE annoyances</strong>. The last step to getting a working app is to
handle some annoyances using BLE serialization with the <code>simple_ble</code> library.
Typically errors generated by the nRF51 SDK are severe and mean there is a
significant bug in the code. With serialization, however, messages between
the two processors can be corrupted or misframed, causing parsing errors. We
can ignore these errors safely and just drop the corrupted packet.</p>
<p>Additionally, the <code>simple_ble</code> library makes it easy to set the address
of a BLE device. However, this functionality only works when running
on an actual nRF51822. To disable this, we override the weakly defined
<code>ble_address_set()</code> function with an empty function.</p>
<pre><code class="language-c">void app_error_fault_handler(uint32_t error_code, uint32_t line_num, uint32_t info) { }
void ble_address_set () { }
</code></pre>
</li>
<li>
<p><strong>Run the app and see the packets!</strong> To try this tutorial application, you
can find it in the <a href="https://github.com/tock/libtock-c/tree/master/examples/tutorials/03_ble_scan">tutorials app
folder</a>.</p>
<p>For any new applications, ensure that the following is in the makefile
so that the BLE serialization library is included.</p>
<pre><code> include $(TOCK_USERLAND_BASE_DIR)/libnrfserialization/Makefile.app
</code></pre>
</li>
</ol>
<h2><a class="header" href="#details" id="details">Details</a></h2>
<p>This section contains a few notes about the specific versions of BLE
serialization used.</p>
<p>Tock currently supports the S130 softdevice version 2.0.0 and SDK 11.0.0.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../tutorials/02_button_print.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../tutorials/04_sensors_and_drivers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../tutorials/02_button_print.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="../tutorials/04_sensors_and_drivers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
